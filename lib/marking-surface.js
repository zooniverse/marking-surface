// Generated by CoffeeScript 1.4.0
(function() {
  var $, BaseClass, MOUSE_EVENTS, Mark, MarkingSurface, Raphael, Tool, body, doc, win,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  $ = window.jQuery;

  Raphael = window.Raphael;

  win = $(window);

  doc = $(document);

  body = $(document.body);

  MOUSE_EVENTS = ['mousedown', 'mouseover', 'mousemove', 'mouseout', 'mouseup'];

  BaseClass = (function() {
    var method, _fn, _i, _len, _ref,
      _this = this;

    BaseClass.prototype.jQueryEventProxy = null;

    function BaseClass(params) {
      var property, value;
      if (params == null) {
        params = {};
      }
      for (property in params) {
        if (!__hasProp.call(params, property)) continue;
        value = params[property];
        if (property in this) {
          this[property] = value;
        }
      }
      this.jQueryEventProxy = $({});
    }

    BaseClass.prototype.destroy = function() {
      this.trigger('destroy');
      return this.off();
    };

    _ref = ['on', 'one', 'trigger', 'off'];
    _fn = function(method) {
      return BaseClass.prototype[method] = function() {
        var _ref1;
        return (_ref1 = this.jQueryEventProxy)[method].apply(_ref1, arguments);
      };
    };
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      method = _ref[_i];
      _fn(method);
    }

    return BaseClass;

  }).call(this);

  Mark = (function(_super) {

    __extends(Mark, _super);

    function Mark() {
      return Mark.__super__.constructor.apply(this, arguments);
    }

    Mark.prototype.set = function(property, value, _arg) {
      var fromMany, map, setter;
      fromMany = (_arg != null ? _arg : {}).fromMany;
      if (typeof property === 'string') {
        setter = this["set " + property];
        this[property] = setter ? setter.call(this, value) : value;
      } else {
        map = property;
        for (property in map) {
          value = map[property];
          this.set(property, value, {
            fromMany: true
          });
        }
      }
      if (!fromMany) {
        return this.trigger('change', property, value);
      }
    };

    Mark.prototype.toJSON = function() {
      var property, result, value;
      result = {};
      for (property in this) {
        value = this[property];
        if (property === 'jQueryEventProxy') {
          continue;
        }
        if (typeof value === 'function') {
          continue;
        }
        result[property] = value;
      }
      return result;
    };

    return Mark;

  })(BaseClass);

  Tool = (function(_super) {

    __extends(Tool, _super);

    Tool.Mark = Mark;

    Tool.prototype.cursors = null;

    Tool.prototype.mark = null;

    Tool.prototype.markDefaults = null;

    Tool.prototype.surface = null;

    Tool.prototype.shapeSet = null;

    function Tool() {
      var _ref, _ref1,
        _this = this;
      Tool.__super__.constructor.apply(this, arguments);
      if ((_ref = this.mark) == null) {
        this.mark = new this.constructor.Mark;
      }
      if (this.markDefaults != null) {
        this.mark.set(this.markDefaults);
      }
      this.mark.on('change', function() {
        return _this.render.apply(_this, arguments);
      });
      this.mark.on('destroy', function() {
        return _this.destroy.apply(_this, arguments);
      });
      this.deleteButton = $('<button name="delete-mark">&times;</button>');
      this.deleteButton.css({
        position: 'absolute'
      });
      this.deleteButton.on('click', function() {
        return _this.onClickDelete.apply(_this, arguments);
      });
      this.deleteButton.appendTo(this.surface.container);
      if ((_ref1 = this.shapeSet) == null) {
        this.shapeSet = this.surface.paper.set();
      }
      setTimeout(function() {
        var eventName, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = MOUSE_EVENTS.length; _i < _len; _i++) {
          eventName = MOUSE_EVENTS[_i];
          _results.push(_this.shapeSet[eventName](function() {
            return _this.handleEvents.apply(_this, arguments);
          }));
        }
        return _results;
      });
    }

    Tool.prototype.addShape = function() {
      var attributes, params, shape, type, _ref;
      type = arguments[0], params = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      if (typeof params[params.length - 1] === 'object') {
        attributes = params.pop();
      }
      shape = (_ref = this.surface.paper)[type.toLowerCase()].apply(_ref, params);
      shape.attr(attributes);
      this.shapeSet.push(shape);
      return shape;
    };

    Tool.prototype.onInitialClick = function(e) {
      this.trigger('initial-click', [e]);
      return this.onFirstClick(e);
    };

    Tool.prototype.onInitialDrag = function(e) {
      var _this = this;
      doc.one('mouseup touchend', function(e) {
        return _this.trigger('initial-drag', [e]);
      });
      return this.onFirstDrag(e);
    };

    Tool.prototype.isComplete = function() {
      return true;
    };

    Tool.prototype.handleEvents = function(e) {
      var isArray, name, onDrag, onNamedDrag, property, shape, target, type, value, _ref, _ref1, _ref2,
        _this = this;
      if (this.surface.disabled) {
        return;
      }
      type = e.type;
      target = e.target || e.srcElement;
      shape = this.surface.paper.getById(target.raphaelid);
      for (property in this) {
        value = this[property];
        isArray = value instanceof Array || value instanceof this.shapeSet.constructor;
        if ((value === shape) || (isArray && __indexOf.call(value, shape) >= 0)) {
          name = property;
        }
      }
      if ((_ref = this["on " + type]) != null) {
        _ref.call(this, e, shape);
      }
      if (name) {
        if ((_ref1 = this["on " + type + " " + name]) != null) {
          _ref1.call(this, e, shape);
        }
      }
      if (type === 'mouseover' && name) {
        body.css({
          cursor: ((_ref2 = this.cursors) != null ? _ref2[name] : void 0) || ''
        });
      }
      if (type === 'mouseout') {
        body.css({
          cursor: ''
        });
      }
      if (type === 'mousedown' || type === 'touchstart') {
        e.preventDefault();
        this.select();
        if ('on drag' in this) {
          onDrag = function() {
            return _this['on drag'].apply(_this, __slice.call(arguments).concat([shape]));
          };
          doc.on('mousemove touchmove', onDrag);
          doc.one('mouseup touchend', function() {
            return doc.off('mousemove touchmove', onDrag);
          });
        }
        if (name && ("on drag " + name) in this) {
          onNamedDrag = function() {
            return _this["on drag " + name].apply(_this, __slice.call(arguments).concat([shape]));
          };
          doc.on('mousemove touchmove', onNamedDrag);
          return doc.one('mouseup touchend', function() {
            return doc.off('mousemove touchmove', onNamedDrag);
          });
        }
      }
    };

    Tool.prototype.onClickDelete = function(e) {
      return this.mark.destroy();
    };

    Tool.prototype.select = function() {
      this.shapeSet.attr({
        opacity: 1
      });
      this.deleteButton.show();
      this.shapeSet.toFront();
      return this.trigger('select', arguments);
    };

    Tool.prototype.deselect = function() {
      this.shapeSet.attr({
        opacity: 0.5
      });
      this.deleteButton.hide();
      return this.trigger('deselect', arguments);
    };

    Tool.prototype.destroy = function() {
      var _this = this;
      this.deleteButton.off();
      return this.shapeSet.animate({
        opacity: 0,
        r: 0,
        'stroke-width': 0
      }, 250, 'ease-in', function() {
        _this.shapeSet.remove();
        _this.deleteButton.remove();
        return Tool.__super__.destroy.apply(_this, arguments);
      });
    };

    Tool.prototype.mouseOffset = function() {
      var _ref;
      return (_ref = this.surface).mouseOffset.apply(_ref, arguments);
    };

    Tool.prototype.onFirstClick = function(e) {};

    Tool.prototype.onFirstDrag = function(e) {};

    Tool.prototype.render = function() {};

    return Tool;

  })(BaseClass);

  MarkingSurface = (function(_super) {

    __extends(MarkingSurface, _super);

    MarkingSurface.prototype.tool = Tool;

    MarkingSurface.prototype.container = null;

    MarkingSurface.prototype.className = 'marking-surface';

    MarkingSurface.prototype.width = 400;

    MarkingSurface.prototype.height = 300;

    MarkingSurface.prototype.background = '';

    MarkingSurface.prototype.paper = null;

    MarkingSurface.prototype.image = null;

    MarkingSurface.prototype.marks = null;

    MarkingSurface.prototype.tools = null;

    MarkingSurface.prototype.zoomBy = 1;

    MarkingSurface.prototype.zoomX = 0;

    MarkingSurface.prototype.zoomY = 0;

    MarkingSurface.prototype.selection = null;

    MarkingSurface.prototype.disabled = false;

    function MarkingSurface(params) {
      var _ref, _ref1, _ref2, _ref3,
        _this = this;
      if (params == null) {
        params = {};
      }
      MarkingSurface.__super__.constructor.apply(this, arguments);
      if ((_ref = this.container) == null) {
        this.container = document.createElement('div');
      }
      this.container = $(this.container);
      this.container.addClass(this.className);
      this.container.attr({
        tabindex: 0
      });
      this.container.on('blur', function() {
        return _this.onBlur.apply(_this, arguments);
      });
      this.container.on('focus', function() {
        return _this.onFocus.apply(_this, arguments);
      });
      if (this.container.parents().length !== 0) {
        if (!('width' in params)) {
          this.width = this.container.width() || this.width;
        }
        if (!('height' in params)) {
          this.height = this.container.height() || this.height;
        }
      }
      if ((_ref1 = this.paper) == null) {
        this.paper = Raphael(this.container.get(0), this.width, this.height);
      }
      this.image = this.paper.image(this.background, 0, 0, this.width, this.height);
      if ((_ref2 = this.marks) == null) {
        this.marks = [];
      }
      if ((_ref3 = this.tools) == null) {
        this.tools = [];
      }
      if (this.disabled) {
        disable();
      }
      this.container.on('mousedown touchstart', function() {
        return _this.onMouseDown.apply(_this, arguments);
      });
      this.container.on('mousemove touchmove', function() {
        return _this.onMouseMove.apply(_this, arguments);
      });
      this.container.on('keydown', function() {
        return _this.onKeyDown.apply(_this, arguments);
      });
    }

    MarkingSurface.prototype.resize = function(width, height) {
      this.width = width;
      this.height = height;
      this.paper.setSize(this.width, this.height);
      return this.image.attr({
        width: this.width,
        height: this.height
      });
    };

    MarkingSurface.prototype.zoom = function(zoomBy, zoomX, zoomY) {
      var tool, _i, _len, _ref, _results;
      this.zoomBy = zoomBy != null ? zoomBy : this.zoomBy;
      this.zoomX = zoomX != null ? zoomX : this.zoomX;
      this.zoomY = zoomY != null ? zoomY : this.zoomY;
      this.zoomX = Math.min(this.width, this.zoomX);
      this.zoomY = Math.min(this.height, this.zoomY);
      this.paper.setViewBox(this.zoomX, this.zoomY, this.width / this.zoomBy, this.height / this.zoomBy);
      _ref = this.tools;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tool = _ref[_i];
        _results.push(tool.render());
      }
      return _results;
    };

    MarkingSurface.prototype.onMouseMove = function(e) {
      var x, y, _ref;
      if (this.zoomBy === 1) {
        return;
      }
      _ref = this.mouseOffset(e), x = _ref.x, y = _ref.y;
      this.zoomX = (this.width - (this.width / this.zoomBy)) * (x / this.width);
      this.zoomY = (this.height - (this.height / this.zoomBy)) * (y / this.height);
      return this.zoom();
    };

    MarkingSurface.prototype.onMouseDown = function(e) {
      var mark, onDrag, tool, _ref,
        _this = this;
      if (this.disabled) {
        return;
      }
      if ((_ref = e.target) !== this.container.get(0) && _ref !== this.paper.canvas && _ref !== this.image.node) {
        return;
      }
      if (e.isDefaultPrevented()) {
        return;
      }
      this.container.focus();
      e.preventDefault();
      if (!(this.selection != null) || this.selection.isComplete()) {
        tool = new this.tool({
          surface: this
        });
        mark = tool.mark;
        this.tools.push(tool);
        this.marks.push(mark);
        tool.on('select', function() {
          var i, index, t, _i, _len, _ref1, _ref2;
          if (_this.selection !== tool) {
            if ((_ref1 = _this.selection) != null) {
              _ref1.deselect();
            }
          }
          _ref2 = _this.tools;
          for (i = _i = 0, _len = _ref2.length; _i < _len; i = ++_i) {
            t = _ref2[i];
            if (t === tool) {
              index = i;
            }
          }
          _this.tools.splice(index, 1);
          _this.tools.push(tool);
          return _this.selection = tool;
        });
        tool.on('deselect', function() {
          return _this.selection = null;
        });
        tool.on('destroy', function() {
          var i, index, t, _i, _len, _ref1, _ref2;
          _ref1 = _this.tools;
          for (i = _i = 0, _len = _ref1.length; _i < _len; i = ++_i) {
            t = _ref1[i];
            if (t === tool) {
              index = i;
            }
          }
          _this.tools.splice(index, 1);
          if (tool === _this.selection) {
            return (_ref2 = _this.tools[_this.tools.length - 1]) != null ? _ref2.select() : void 0;
          }
        });
        mark.on('destroy', function() {
          var i, index, m, _i, _len, _ref1;
          _ref1 = _this.marks;
          for (i = _i = 0, _len = _ref1.length; _i < _len; i = ++_i) {
            m = _ref1[i];
            if (m === mark) {
              index = i;
            }
          }
          return _this.marks.splice(index, 1);
        });
        tool.select();
      } else {
        tool = this.selection;
      }
      tool.select();
      tool.onInitialClick(e);
      onDrag = function() {
        return _this.onDrag.apply(_this, arguments);
      };
      doc.on('mousemove touchmove', onDrag);
      return doc.one('mouseup touchend', function() {
        return doc.off('mousemove touchmove', onDrag);
      });
    };

    MarkingSurface.prototype.onDrag = function(e) {
      return this.selection.onInitialDrag(e);
    };

    MarkingSurface.prototype.onKeyDown = function(e) {
      var _ref, _ref1;
      if ((_ref = e.which) === 8 || _ref === 46) {
        e.preventDefault();
        return (_ref1 = this.selection) != null ? _ref1.mark.destroy() : void 0;
      } else if (e.which === 9 && (this.selection != null)) {
        e.preventDefault();
        if (e.shiftKey) {
          this.tools.unshift(this.tools.pop());
        } else {
          this.tools.push(this.tools.shift());
        }
        return this.tools[this.tools.length - 1].select();
      }
    };

    MarkingSurface.prototype.onFocus = function() {
      var _ref;
      return (_ref = this.selection) != null ? _ref.select() : void 0;
    };

    MarkingSurface.prototype.onBlur = function() {
      var _ref;
      if (this.container.has(document.activeElement)) {
        return;
      }
      return (_ref = this.selection) != null ? _ref.deselect() : void 0;
    };

    MarkingSurface.prototype.disable = function(e) {
      var _ref;
      this.disabled = true;
      this.container.attr({
        disabled: true
      });
      this.container.addClass('disabled');
      return (_ref = this.selection) != null ? _ref.deselect() : void 0;
    };

    MarkingSurface.prototype.enable = function(e) {
      this.disabled = false;
      this.container.attr({
        disabled: false
      });
      return this.container.removeClass('disabled');
    };

    MarkingSurface.prototype.destroy = function() {
      var mark, _i, _len, _ref;
      this.container.off().remove();
      _ref = this.marks;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        mark = _ref[_i];
        mark.destroy();
      }
      return MarkingSurface.__super__.destroy.apply(this, arguments);
    };

    MarkingSurface.prototype.mouseOffset = function(e) {
      var left, originalEvent, top, _ref;
      if ('originalEvent' in e) {
        originalEvent = e.originalEvent;
      }
      if ((originalEvent != null) && 'touches' in originalEvent) {
        e = originalEvent.touches[0];
      }
      _ref = this.container.offset(), left = _ref.left, top = _ref.top;
      left += parseFloat(this.container.css('padding-left'));
      left += parseFloat(this.container.css('border-left-width'));
      top += parseFloat(this.container.css('padding-top'));
      top += parseFloat(this.container.css('border-top-width'));
      return {
        x: e.pageX - left,
        y: e.pageY - top
      };
    };

    return MarkingSurface;

  })(BaseClass);

  MarkingSurface.Mark = Mark;

  MarkingSurface.Tool = Tool;

  window.MarkingSurface = MarkingSurface;

  if (typeof module !== "undefined" && module !== null) {
    module.exports = MarkingSurface;
  }

}).call(this);
